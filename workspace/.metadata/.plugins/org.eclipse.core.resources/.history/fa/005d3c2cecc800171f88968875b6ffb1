package com.acj.rmi.server;

import java.rmi.RemoteException;
import java.rmi.server.UnicastRemoteObject;
import java.util.ArrayList;
import java.util.List;

import java.sql.*;

public class StudentInfoImpl extends UnicastRemoteObject implements IStudentInfo { 

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;
	static Connection con;   
	
	protected StudentInfoImpl() throws RemoteException {
		super();
	    
		Class.forName("com.mysql.jdbc.Driver");   

		final String USER = "root";
		final String PASS = "pwd123456";
		System.out.println("Connecting to database...");
		conn = DriverManager.getConnection(DB_URL,USER,PASS);
		
        //驱动程序名
        String driver = "com.mysql.jdbc.Driver";
        //URL指向要访问的数据库名mydata
        String url = "jdbc:mysql://localhost:3306/rmi_test";
        //MySQL配置时的用户名
        String user = "root";
        //MySQL配置时的密码
        String password = "";
        //遍历查询结果集
        try {
            //加载驱动程序
            Class.forName(driver);
            //1.getConnection()方法，连接MySQL数据库！！
            con = (Connection) DriverManager.getConnection(url,user,password);
            if(!con.isClosed())
                System.out.println("Succeeded connecting to the Database!");
        } catch(ClassNotFoundException e) {   
            //数据库驱动类异常处理
            System.out.println("Sorry,can`t find the Driver!");   
            e.printStackTrace();   
        } 
		
	}

	@Override
	public List<Student> list() throws RemoteException {
		List<Student> r = new ArrayList<Student>();
		try{
			Statement statement = (Statement) con.createStatement();
			String sql = "select * from `students`";
			ResultSet rs;
			rs = statement.executeQuery(sql);
			
		    Long id = null;
		    String name = null;
		    int grade = -1;	    
		    while(rs.next()){
		    	id = rs.getLong("id");
		    	name = rs.getString("name");
		    	grade = rs.getInt("grade");
		    	r.add(new Student(id,name,grade));
		    }
		    rs.close();
		    		
		}catch (Exception e) {
			e.printStackTrace();
		}
		return r;
	}

	@Override
	public Student getStu(Long id) throws RemoteException {
		Student r = null;
		try{	
			String sql = "select * from `students` WHERE id = ?";			
			PreparedStatement ps=(PreparedStatement) con.prepareStatement(sql);
			ps.setLong(1, id);
			ResultSet rs=ps.executeQuery();
			
		    if (rs.next()){
		    	r = new Student();
		    	r.setId(rs.getLong("id") );
		    	r.setName(rs.getString("name"));
		    	r.setGrade( rs.getInt("grade"));
		    }			    
		    rs.close();		
		}catch (Exception e) {
			e.printStackTrace();
		}
		return r;
	}
}
